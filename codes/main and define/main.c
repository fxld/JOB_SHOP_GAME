#include"define.h"

DATA **data = NULL;//输入数据data[Element][Machine]
GENE island[ISLAND][MAXnum];//2个岛屿
PROCESS **Process = NULL;//使用二维数组存放解码出的设计图Process[Machine][Element]
PROCESS **BestProcess = NULL;//存放最优的设计图BestProcess[Machine][Element]
GENE random_pair[TSIZE];
GENE **offspring_tselect = NULL;
GENE **offspring_eselect = NULL;
//int after_select[ISLAND][MAXnum];//选择后基因的映射after_select[island][index of the selected],当after_selected[i][j]=-1时,表示已经进行过基因操作或是未选择
int Element;//需加工的工件总数
int Machine;//机器总数
int Job;//总操作数，也就是基因的实际长度
int age;//当前进化代数
int MutantRange = (int)(((double)RAND_MAX)*MUTATION);//当rand()的值在[0,MutantRange]时发生突变
int CrossoverRange = (int)(((double)RAND_MAX)*CROSS);//当rand()的值在[0,CrossoverRange]时发生交叉
int TournamentRange = (int)(((double)RAND_MAX)*TRANGE);
int elite_size = (int)(ELITE*(double)MAXnum) >= 1 ? (int)(ELITE*(double)MAXnum) : 1;
//int elite_size = 0;
int nelite_size = MAXnum - (int)(ELITE*(double)MAXnum);
int max_operate_num = (MAXnum - (int)(ELITE*(double)MAXnum)) / TSIZE;
int crossovered[ISLAND][MAXnum] = { -1 };
double Sum_fitness[2];//岛屿中所有个体适应度的和
int BestMakeSpan = 99999;//最优解的最长完工时间


int main(void)
{
	int i, j;
	/**************************
	*	input();		//输入
	*	initGen();		//生成初始种群
	*	decode();		//解码
	*	fitness();		//计算适应度
	*	while(terminate())//是否达成跳出循环
	*	{
	*		sort();		//排序(依据适应度/运行时间)
	*		select();	//选择
	*		crossover();//交叉
	*		mutant();	//变异
	*		if(age%MOVEage==0)//判断是否迁移
	*			move();	//迁移
	*	}
	*	output();		//输出
	*	//animate();
	*	return 0;
	*/
	srand((unsigned int)time(NULL));
	input();
	InitGen();

	Process = (PROCESS**)malloc((Machine + 1) * sizeof(PROCESS*));//Process申请内存
	if (Process != NULL)
		for (int i = 0; i < Machine + 1; i++)
			Process[i] = (PROCESS*)malloc((Element + 1) * sizeof(PROCESS));

	BestProcess = (PROCESS**)malloc((Machine + 1) * sizeof(PROCESS*));//BestProcess申请内存
	if (BestProcess != NULL)
		for (int i = 0; i < Machine + 1; i++)
			BestProcess[i] = (PROCESS*)malloc((Element + 1) * sizeof(PROCESS));

	GENE *temporary = NULL;//临时空间（用于排序）
	temporary = (GENE*)malloc((MAXnum + 1) * sizeof(GENE));

	for (i = 0; i < ISLAND; i++)
		for (j = 0; j < MAXnum; j++)
			decode(&island[i][j]);

	while (terminate())
	{
		for (i = 0; i < ISLAND; i++)
			sort(0, MAXnum, island[i], temporary);//排序

		select(&offspring_eselect, &offspring_tselect);

		for (i = 0; i < ISLAND; i++)
		{
			crossover(offspring_tselect[i], i);
			mutant(offspring_tselect[i], i);
		}

		for (i = 0; i < ISLAND; i++)
		{
			memcpy(island[i], offspring_eselect[i], elite_size * sizeof(GENE));
			memcpy(island[i] + elite_size, offspring_tselect[i], nelite_size * sizeof(GENE));
		}

		if (age%MOVEage == 0)
			move();

		if (age%100==0)
			srand((unsigned int)time(NULL));

		//printf("age:%d\tisland1.makespan:%d\tisland2.makespan:%d\tBestMakeSpan:%d", age, island[0][0].makespan, island[1][0].makespan, BestMakeSpan);
		//printf("Time %.3f\n", (double)clock() / 1000);
		age++;
	}
	/************dbg**************
	int sum_time = 0;
	for (int i = 0; i < ISLAND; i++)
		for (int j = 0; j < MAXnum; j++)
			sum_time += island[i][j].makespan;
	printf("%lf\n", (double)sum_time / ISLAND / MAXnum);
	*/

	output();
	//animate();

	for (int i = 0; i < Machine + 1; i++)
		free(Process[i]);
	free(Process); 
	for (int i = 0; i < Machine + 1; i++)
		free(BestProcess[i]);
	free(BestProcess);
	free(temporary);
	for (int i = 0; i < Element + 1; i++)
		free(data[i]);
	free(data);
	for (int i = 0; i < ISLAND; i++)
		free(offspring_eselect[i]);
	free(offspring_eselect);
	for (int i = 0; i < ISLAND; i++)
		free(offspring_tselect[i]);
	free(offspring_tselect);

	//system("pause");
	return 0;
}

/*
3 3
0 7 1 3 2 15
2 1 1 10 0 17
0 7 1 22 2 3

la01/ac
10 5
1 21 0 53 4 95 3 55 2 34
0 21 3 52 4 16 2 26 1 71
3 39 4 98 1 42 2 31 0 12
1 77 0 55 4 79 2 66 3 77
0 83 3 34 2 64 1 19 4 37
1 54 2 43 4 79 0 92 3 62
3 69 4 77 1 87 2 87 0 93
2 38 0 60 1 41 3 24 4 83
3 17 1 49 4 25 0 44 2 98
4 77 3 79 2 43 1 75 0 96

la02/
10 5
0 20 3 87 1 31 4 76 2 17
4 25 2 32 0 24 1 18 3 81
1 72 2 23 4 28 0 58 3 99
2 86 1 76 4 97 0 45 3 90
4 27 0 42 3 48 2 17 1 46
1 67 0 98 4 48 3 27 2 62
4 28 1 12 3 19 0 80 2 50
1 63 0 94 2 98 3 50 4 80
4 14 0 75 2 50 1 41 3 55
4 72 2 18 1 37 3 79 0 61

la16/wa
10 10
1 21 6 71 9 16 8 52 7 26 2 34 0 53 4 21 3 55 5 95
4 55 2 31 5 98 9 79 0 12 7 66 1 42 8 77 6 77 3 39
3 34 2 64 8 62 1 19 4 92 9 79 7 43 6 54 0 83 5 37
1 87 3 69 2 87 7 38 8 24 9 83 6 41 0 93 5 77 4 60
2 98 0 44 5 25 6 75 7 43 1 49 4 96 9 77 3 17 8 79
2 35 3 76 5 28 9 10 4 61 6  9 0 95 8 35 1  7 7 95
3 16 2 59 0 46 1 91 9 43 8 50 6 52 5 59 4 28 7 27
1 45 0 87 3 41 4 20 6 54 9 43 8 14 5  9 2 39 7 71
4 33 2 37 8 66 5 33 3 26 7  8 1 28 6 89 9 42 0 78
8 69 9 81 2 94 4 96 3 27 0 69 7 45 6 78 1 74 5 84

3 3
0 3 1 2 2 3
2 2 0 3 1 4
1 2 2 2 0 3

ft06/ac
6 6
2  1  0  3  1  6  3  7  5  3  4  6
1  8  2  5  4 10  5 10  0 10  3  4
2  5  3  4  5  8  0  9  1  1  4  7
1  5  0  5  2  5  3  3  4  8  5  9
2  9  1  3  4  5  5  4  0  3  3  1
1  3  3  3  5  9  0 10  4  4  2  1

ft10/wa
10 10
0 29 1 78 2  9 3 36 4 49 5 11 6 62 7 56 8 44 9 21
0 43 2 90 4 75 9 11 3 69 1 28 6 46 5 46 7 72 8 30
1 91 0 85 3 39 2 74 8 90 5 10 7 12 6 89 9 45 4 33
1 81 2 95 0 71 4 99 6  9 8 52 7 85 3 98 9 22 5 43
2 14 0  6 1 22 5 61 3 26 4 69 8 21 7 49 9 72 6 53
2 84 1  2 5 52 3 95 8 48 9 72 0 47 6 65 4  6 7 25
1 46 0 37 3 61 2 13 6 32 5 21 9 32 8 89 7 30 4 55
2 31 0 86 1 46 5 74 4 32 6 88 8 19 9 48 7 36 3 79
0 76 1 69 3 76 5 51 2 85 9 11 6 40 7 89 4 26 8 74
1 85 0 13 2 61 6  7 8 64 9 76 5 47 3 52 4 90 7 45

ft20/wa
20 5
0 29 1  9 2 49 3 62 4 44
0 43 1 75 3 69 2 46 4 72
1 91 0 39 2 90 4 12 3 45
1 81 0 71 4  9 2 85 3 22
2 14 1 22 0 26 3 21 4 72
2 84 1 52 4 48 0 47 3  6
1 46 0 61 2 32 3 32 4 30
2 31 1 46 0 32 3 19 4 36
0 76 3 76 2 85 1 40 4 26
1 85 2 61 0 64 3 47 4 90
1 78 3 36 0 11 4 56 2 21
2 90 0 11 1 28 3 46 4 30
0 85 2 74 1 10 3 89 4 33
2 95 0 99 1 52 3 98 4 43
0  6 1 61 4 69 2 49 3 53
1  2 0 95 3 72 4 65 2 25
0 37 2 13 1 21 3 89 4 55
0 86 1 74 4 88 2 48 3 79
1 69 2 51 0 11 3 89 4 74
0 13 1  7 2 76 3 52 4 45

la06/ac
15 5
1 21 2 34 4 95 0 53 3 55
3 52 4 16 1 71 2 26 0 21
2 31 0 12 1 42 3 39 4 98
3 77 1 77 4 79 0 55 2 66
4 37 3 34 2 64 1 19 0 83
2 43 1 54 0 92 3 62 4 79
0 93 3 69 1 87 4 77 2 87
0 60 1 41 2 38 4 83 3 24
2 98 3 17 4 25 0 44 1 49
0 96 4 77 3 79 1 75 2 43
4 28 2 35 0 95 3 76 1  7
0 61 4 10 2 95 1  9 3 35
4 59 3 16 1 91 2 59 0 46
4 43 1 52 0 28 2 27 3 50
0 87 1 45 2 39 4  9 3 41

la11/ac
20 5
2 34 1 21 0 53 3 55 4 95
0 21 3 52 1 71 4 16 2 26
0 12 1 42 2 31 4 98 3 39
2 66 3 77 4 79 0 55 1 77
0 83 4 37 3 34 1 19 2 64
4 79 2 43 0 92 3 62 1 54
0 93 4 77 2 87 1 87 3 69
4 83 3 24 1 41 2 38 0 60
4 25 1 49 0 44 2 98 3 17
0 96 1 75 2 43 4 77 3 79
0 95 3 76 1  7 4 28 2 35
4 10 2 95 0 61 1  9 3 35
1 91 2 59 4 59 0 46 3 16
2 27 1 52 4 43 0 28 3 50
4  9 0 87 3 41 2 39 1 45
1 54 0 20 4 43 3 14 2 71
4 33 1 28 3 26 0 78 2 37
1 89 0 33 2  8 3 66 4 42
4 84 0 69 2 94 1 74 3 27
4 81 2 45 1 78 3 69 0 96

la18/wa
10 10
6 54 0 87 4 48 3 60 7 39 8 35 1 72 5 95 2 66 9  5
3 20 9 46 6 34 5 55 0 97 8 19 4 59 2 21 7 37 1 46
4 45 1 24 8 28 0 28 7 83 6 78 5 23 3 25 9  5 2 73
9 12 1 37 4 38 3 71 8 33 2 12 6 55 0 53 7 87 5 29
3 83 2 49 6 23 9 27 7 65 0 48 4 90 5  7 1 40 8 17
1 66 4 25 0 62 2 84 9 13 6 64 7 46 8 59 5 19 3 85
1 73 3 80 0 41 2 53 9 47 7 57 8 74 4 14 6 67 5 88
5 64 3 84 6 46 1 78 0 84 7 26 8 28 9 52 2 41 4 63
1 11 0 64 7 67 4 85 3 10 5 73 9 38 8 95 6 97 2 17
4 60 8 32 2 95 3 93 1 65 6 85 7 43 9 85 5 46 0 59

la21/wa
15 10
2 34 3 55 5 95 9 16 4 21 6 71 0 53 8 52 1 21 7 26
3 39 2 31 0 12 1 42 9 79 8 77 6 77 5 98 4 55 7 66
1 19 0 83 3 34 4 92 6 54 9 79 8 62 5 37 2 64 7 43
4 60 2 87 8 24 5 77 3 69 7 38 1 87 6 41 9 83 0 93
8 79 9 77 2 98 4 96 3 17 0 44 7 43 6 75 1 49 5 25
8 35 7 95 6  9 9 10 2 35 1  7 5 28 4 61 0 95 3 76
4 28 5 59 3 16 9 43 0 46 8 50 6 52 7 27 2 59 1 91
5  9 4 20 2 39 6 54 1 45 7 71 0 87 3 41 9 43 8 14
1 28 5 33 0 78 3 26 2 37 7  8 8 66 6 89 9 42 4 33
2 94 5 84 6 78 9 81 1 74 3 27 8 69 0 69 7 45 4 96
1 31 4 24 0 20 2 17 9 25 8 81 5 76 3 87 7 32 6 18
5 28 9 97 0 58 4 45 6 76 3 99 2 23 1 72 8 90 7 86
5 27 9 48 8 27 7 62 4 98 6 67 3 48 0 42 1 46 2 17
1 12 8 50 0 80 2 50 9 80 3 19 5 28 6 63 4 94 7 98
4 61 3 55 6 37 5 14 2 50 8 79 1 41 9 72 7 18 0 75

la24/wa
15 10
7  8 9 75 0 72 6 74 4 30 8 43 2 38 5 98 1 26 3 19
6 19 8 73 3 43 0 23 1 85 4 39 5 13 9 26 2 67 7  9
1 50 3 93 5 80 4  7 0 55 2 61 6 57 8 72 9 42 7 46
1 68 7 43 4 99 6 60 5 68 0 91 8 11 3 96 9 11 2 72
7 84 2 34 8 40 5  7 1 70 6 74 3 12 0 43 9 69 4 30
8 60 0 49 4 59 5 72 9 63 1 69 7 99 6 45 3 27 2  9
6 71 2 91 8 65 1 90 9 98 4  8 7 50 0 75 5 37 3 17
8 62 7 90 5 98 3 31 2 91 4 38 9 72 1  9 0 72 6 49
4 35 0 39 9 74 5 25 7 47 3 52 2 63 8 21 6 35 1 80
9 58 0  5 3 50 8 52 1 88 6 20 2 68 5 24 4 53 7 57
7 99 3 91 4 33 5 19 2 18 6 38 0 24 9 35 1 49 8  9
0 68 3 60 2 77 7 10 8 60 5 15 9 72 1 18 6 90 4 18
9 79 1 60 3 56 6 91 2 40 8 86 7 72 0 80 5 89 4 51
4 10 2 92 5 23 6 46 8 40 7 72 3  6 1 23 0 95 9 34
2 24 5 29 9 49 8 55 0 47 6 77 3 77 7  8 1 28 4 48

la26/wa
20 10
8 52 7 26 6 71 9 16 2 34 1 21 5 95 4 21 0 53 3 55
4 55 5 98 3 39 9 79 0 12 8 77 6 77 7 66 2 31 1 42
5 37 4 92 2 64 6 54 1 19 7 43 0 83 3 34 9 79 8 62
1 87 5 77 0 93 3 69 2 87 7 38 8 24 6 41 9 83 4 60
2 98 5 25 6 75 9 77 1 49 3 17 8 79 0 44 7 43 4 96
1  7 4 61 0 95 2 35 9 10 8 35 5 28 3 76 7 95 6  9
5 59 9 43 0 46 4 28 6 52 3 16 2 59 1 91 8 50 7 27
5  9 9 43 8 14 7 71 4 20 6 54 3 41 0 87 1 45 2 39
1 28 8 66 0 78 2 37 9 42 3 26 5 33 6 89 4 33 7  8
4 96 3 27 6 78 5 84 2 94 8 69 1 74 9 81 7 45 0 69
4 24 7 32 9 25 2 17 3 87 8 81 5 76 6 18 1 31 0 20
8 90 5 28 1 72 7 86 2 23 3 99 6 76 9 97 4 45 0 58
2 17 4 98 3 48 1 46 8 27 6 67 7 62 0 42 9 48 5 27
0 80 8 50 3 19 7 98 5 28 2 50 4 94 6 63 1 12 9 80
9 72 0 75 4 61 8 79 6 37 2 50 5 14 3 55 7 18 1 41
3 96 2 14 5 57 0 47 7 65 4 75 8 79 1 71 6 60 9 22
1 31 7 47 8 58 3 32 4 44 5 58 6 34 0 33 2 69 9 51
1 44 7 40 2 17 0 62 8 66 6 15 3 29 9 38 5  8 4 97
2 58 3 50 4 63 9 87 0 57 6 21 7 57 8 32 1 39 5 20
1 85 0 84 5 56 3 61 9 15 7 70 8 30 2 90 6 67 4 20

la31/wa
30 10
4 21 7 26 9 16 2 34 3 55 8 52 5 95 6 71 1 21 0 53
8 77 5 98 1 42 7 66 2 31 3 39 6 77 9 79 4 55 0 12
2 64 4 92 3 34 1 19 8 62 6 54 7 43 0 83 9 79 5 37
0 93 8 24 3 69 7 38 5 77 2 87 4 60 6 41 1 87 9 83
9 77 0 44 4 96 8 79 6 75 2 98 5 25 3 17 7 43 1 49
3 76 2 35 5 28 0 95 7 95 4 61 8 35 1  7 6  9 9 10
1 91 7 27 8 50 3 16 4 28 5 59 6 52 0 46 2 59 9 43
1 45 7 71 2 39 0 87 8 14 6 54 3 41 9 43 5  9 4 20
2 37 3 26 4 33 9 42 0 78 6 89 7  8 8 66 1 28 5 33
1 74 0 69 5 84 3 27 9 81 7 45 8 69 2 94 6 78 4 96
5 76 7 32 6 18 0 20 3 87 2 17 9 25 4 24 1 31 8 81
9 97 8 90 5 28 7 86 0 58 1 72 2 23 6 76 3 99 4 45
9 48 5 27 6 67 7 62 4 98 0 42 1 46 8 27 3 48 2 17
9 80 3 19 5 28 1 12 4 94 6 63 7 98 8 50 0 80 2 50
2 50 1 41 4 61 8 79 5 14 9 72 7 18 3 55 6 37 0 75
9 22 5 57 4 75 2 14 7 65 3 96 1 71 0 47 8 79 6 60
3 32 2 69 4 44 1 31 9 51 0 33 6 34 5 58 7 47 8 58
8 66 7 40 2 17 0 62 9 38 5  8 6 15 3 29 1 44 4 97
3 50 2 58 6 21 4 63 7 57 8 32 5 20 9 87 0 57 1 39
4 20 6 67 1 85 2 90 7 70 0 84 8 30 5 56 3 61 9 15
6 29 0 82 4 18 3 38 7 21 8 50 1 23 5 84 2 45 9 41
3 54 9 37 6 62 5 16 0 52 8 57 4 54 2 38 7 74 1 52
4 79 1 61 8 11 0 81 7 89 6 89 5 57 3 68 9 81 2 30
9 24 1 66 4 32 3 33 8  8 2 20 6 84 0 91 7 55 5 20
3 54 2 64 6 83 9 40 7  8 0  7 4 19 5 56 1 39 8  7
1  6 4 74 0 63 2 64 9 15 6 42 7 98 8 61 5 40 3 91
1 80 3 75 0 26 2 87 9 22 7 39 8 24 4 75 6 44 5  6
5  8 3 79 6 61 1 15 0 12 7 43 8 26 9 22 2 20 4 80
1 36 0 63 7 10 4 22 3 96 5 40 9  5 8 18 6 33 2 62
4  8 8 15 2 64 3 95 1 96 6 38 7 18 9 23 5 64 0 89

la36/wa
15 15
4 21  3 55  6 71 14 98 10 12  2 34  9 16  1 21  0 53  7 26  8 52  5 95 12 31 11 42 13 39
11 54  4 83  1 77  7 64  8 34 14 79 12 43  0 55  3 77  6 19  9 37  5 79 10 92 13 62  2 66
9 83  5 77  2 87  7 38  4 60 12 98  0 93 13 17  6 41 10 44  3 69 11 49  8 24  1 87 14 25
5 77  0 96  9 28  6  7  4 95 13 35  7 35  8 76 11  9 12 95  2 43  1 75 10 61 14 10  3 79
10 87  4 28  8 50  2 59  0 46 11 45 14  9  9 43  6 52  7 27  1 91 13 41  3 16  5 59 12 39
0 20  2 71  4 78 13 66  3 14 12  8 14 42  6 28  1 54  9 33 11 89  8 26  7 37 10 33  5 43
8 69  4 96 12 17  0 69  7 45 11 31  6 78 10 20  3 27 13 87  1 74  5 84 14 76  2 94  9 81
4 58 13 90 11 76  3 81  7 23  9 28  1 18  2 32 12 86  8 99 14 97  0 24 10 45  6 72  5 25
5 27  1 46  6 67  8 27 13 19 10 80  2 17  3 48  7 62 11 12 14 28  4 98  0 42  9 48 12 50
11 37  5 80  4 75  8 55  7 50  0 94  9 14  6 41 14 72  3 50 10 61 13 79  2 98 12 18  1 63
7 65  3 96  0 47  4 75 12 69 14 58 10 33  1 71  9 22 13 32  5 57  8 79  2 14 11 31  6 60
1 34  2 47  3 58  5 51  4 62  6 44  9  8  7 17 10 97  8 29 11 15 13 66 12 40  0 44 14 38
3 50  7 57 13 61  5 20 11 85 12 90  2 58  4 63 10 84  1 39  9 87  6 21 14 56  8 32  0 57
9 84  7 45  5 15 14 41 10 18  4 82 11 29  2 70  1 67  3 30 13 50  6 23  0 20 12 21  8 38
9 37 10 81 11 61 14 57  8 57  0 52  7 74  6 62 12 30  1 52  2 38 13 68  4 54  3 54  5 16

la38/wa
15 15
1 26 12 67  0 72  6 74 14 13  8 43  4 30  3 19 10 23 11 85  5 98 13 43  2 38  7  8  9 75
14 42  0 39  4 55 12 46  1 19  8 93  9 80  5 26 10  7  6 50 11 57  3 73  2  9  7 61 13 72
3 96  4 99 12 34  6 60  7 43 14  7 13 12  8 11 11 70 10 43  0 91  1 68  9 11  5 68  2 72
14 63 11 45  4 49  1 74  8 27  0 30  9 72  7  9 12 99 13 60  5 69  6 69  2 84  3 40 10 59
2 91  0 75  9 98  3 17 10 72 13 31 11  9 14 98  7 50  5 37  4  8  8 65  1 90 12 91  6 71
11 35  6 80  4 39  3 62 14 74  5 72 10 35  9 25  1 49  8 52  7 63  2 90 13 21 12 47  0 38
14 19  7 57 10 24 13 91  3 50  0  5 11 49 12 18  9 58  5 24  8 52  1 88  2 68  6 20  4 53
7 77 14 72  5 35 11 90  4 68  6 18  3  9  0 33  8 60 10 18 12 10 13 60  1 38  2 99  9 15
13  6  8 86  2 40  9 79 12 92 11 23  5 89 10 95  6 91  7 72  0 80  1 60  3 56  4 51 14 23
1 46  6 28  5 34 11 77  4 47  0 10 14 49  8 77 10 48  7 24 12  8  2 72 13 55  9 29  3 40
10 22  4 89 12 79  0  7  9 15  1  6 11 30  6 38  5 11  8 52  3 20  7  5 14  9  2 20 13 28
5 73 14 56  2 37  3 22 13 25  6 58  1  8  7 93  4 88  8 17 12  9 11 69 10 71  9 85  0 55
9 85 14 58  3 46  8 64  2 49  6 37  1 33  4 30  5 26  0 20 13 74 10 77 12 99 11 56  7 21
10 17  3 24  4 89  5 15 11 60  1 42  8 98  2 64 13 92  0 63  7 52 12 54  6 75 14 23  9 38
3  8  5 17 11 56  7 93 14 26  9 62  6  7 10 88  0 97  1  7  2 43  8 29 13 35 12 87  4 57
*/